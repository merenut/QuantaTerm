#!/bin/bash
#
# Pre-commit hook for QuantaTerm
# Runs formatting, linting, and license checks

set -e

echo "ğŸ” Running pre-commit checks..."

# Check if this is an initial commit
if git rev-parse --verify HEAD >/dev/null 2>&1; then
    against=HEAD
else
    # Initial commit: diff against an empty tree object
    against=$(git hash-object -t tree /dev/null)
fi

# Redirect output to stderr
exec 1>&2

# Check for whitespace errors
echo "ğŸ“ Checking for whitespace errors..."
git diff-index --check --cached $against -- || {
    echo "âŒ Whitespace errors found. Please fix them and try again."
    exit 1
}

# Check Rust formatting
echo "ğŸ¨ Checking Rust formatting..."
if ! cargo fmt --all -- --check; then
    echo "âŒ Code is not properly formatted. Run 'cargo fmt --all' to fix."
    exit 1
fi

# Run Clippy
echo "ğŸ“ Running Clippy..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    echo "âŒ Clippy found issues. Please fix them and try again."
    exit 1
fi

# Check for license headers (basic check)
echo "ğŸ“„ Checking for license headers..."
rust_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(rs)$' || true)

if [ -n "$rust_files" ]; then
    for file in $rust_files; do
        if [ -f "$file" ] && ! head -10 "$file" | grep -q "Copyright\|License\|//!"; then
            echo "âš ï¸  Warning: $file might be missing license header or documentation"
        fi
    done
fi

# Check Cargo.toml files
echo "ğŸ“¦ Checking Cargo.toml files..."
toml_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'Cargo\.toml$' || true)

if [ -n "$toml_files" ]; then
    echo "ğŸ“‹ Validating Cargo.toml syntax..."
    for file in $toml_files; do
        if [ -f "$file" ]; then
            # Basic syntax check using cargo check
            if ! cargo check --manifest-path "$file" --quiet 2>/dev/null; then
                echo "âŒ Invalid Cargo.toml syntax in $file"
                exit 1
            fi
        fi
    done
fi

# Run basic tests on staged files
echo "ğŸ§ª Running basic tests..."
if ! cargo test --all --quiet; then
    echo "âŒ Tests failed. Please fix them and try again."
    exit 1
fi

echo "âœ… All pre-commit checks passed!"
exit 0